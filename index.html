<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doc to HTML Converter</title>
    <link rel="stylesheet" href="./index.css">
    <link rel="stylesheet" href="./result.css">
</head>

<body>
<div class="app">
    <div class="main">
        <div class="box">
            <h1>Upload a Document</h1>
            <input type="file" id="fileInput" accept=".md" required>
            <button type="button" id="convertButton">é€šç”¨(Convert)</button>
            <button type="button" id="convertButtonRecent3">å¤§ä¸€ä¸‹(æ€æ”¿)</button>
            <button type="button" id="convertButtonRecent1">å¤§äºŒä¸‹(ä¹ æ¦‚)</button>
            <button type="button" id="convertButtonRecent2">å¤§äºŒä¸‹(æ¯›æ¦‚)</button>
        </div>
    </div>
    <div class="container">
        <div class="resultMain">
            <div class="result"></div>
            <div class="sidebar">
                <h3>é¢˜ç›®å¯¼èˆª</h3>
                <ul class="question-list"></ul>
            </div>
        </div>
        <div class="floor">
            <button type="button" class="resetButton">æ¸…ç©ºå†å²è®°å½•</button>
            <button type="button" class="saveButton">ä¿å­˜åšé¢˜è®°å½•</button>
        </div>
    </div>
    <div class="header" style="text-align: center; margin-bottom: 30px;">
        <div class="footer">
            æœ¬ç«™å·²é€šè¿‡å·¥ä¿¡éƒ¨è®¤è¯&nbsp;&nbsp;
            |&nbsp;&nbsp;
            <a href="https://github.com/luoqwe123/convertToHtml" target="_blank">é¡¹ç›®å¼€æºåœ°å€</a>&nbsp;&nbsp;
            |&nbsp;&nbsp;
            å¤šå¤šä¸–ç•Œç¬¬ä¸€å¯çˆ±âœŒï¸
        </div>
    </div>
</div>

<!-- CDN å¼•å…¥è§£æåº“ -->
<script src="./node_modules/mammoth/mammoth.browser.js"></script>
<script src="./indexDB.js"></script>
<script type="module">
    import {marked} from './node_modules/marked/lib/marked.esm.js';
    import {parseQuestionsToJson} from "./main.js"
    import {main} from "./test.js"

    const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB

    let data = {}
    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ IndexedDB
    document.addEventListener('DOMContentLoaded', async () => {

        data = await getJsonData();
        // console.log(jsonData)

        if (data && Object.keys(data).length != 0) {
            showResult(data);
        }

    });

    // è½¬æ¢æŒ‰é’®äº‹ä»¶ é€šç”¨
    document.getElementById('convertButton').addEventListener('click', async () => {
        const fileInput = document.getElementById('fileInput');
        const file = fileInput.files[0];

        if (!file) {
            console.log('Please select a file.');
            return;
        }

        if (file.size > MAX_FILE_SIZE) {
            console.log('File size exceeds 5MB.');
            return;
        }

        processFile(file);
    });

    // è½¬æ¢æŒ‰é’®äº‹ä»¶ å¸¸ç”¨1 - é€šè¿‡ç›¸å¯¹è·¯å¾„è·å–æ–‡ä»¶
    document.getElementById('convertButtonRecent1').addEventListener('click', async () => {
        processFileFromPath('/lib/xixuan.md', 'first_file.md');
    });

    // è½¬æ¢æŒ‰é’®äº‹ä»¶ å¸¸ç”¨2 - é€šè¿‡ç›¸å¯¹è·¯å¾„è·å–æ–‡ä»¶
    document.getElementById('convertButtonRecent2').addEventListener('click', async () => {
        processFileFromPath('/lib/maoxuan.md', 'second_file.md');
    });

    // è½¬æ¢æŒ‰é’®äº‹ä»¶ å¸¸ç”¨3 - é€šè¿‡ç›¸å¯¹è·¯å¾„è·å–æ–‡ä»¶
    document.getElementById('convertButtonRecent3').addEventListener('click', async () => {
        processFileFromPath('/lib/sizhen.md', 'third_file.md');
    });

    // å¤„ç†æ–‡ä»¶çš„é€šç”¨å‡½æ•°
    async function processFile(file) {
        try {
            let data = await parseFile(file);
            console.log(data);
            data = JSON.parse(data);
            await saveJsonData(data);
            showResult(data);
        } catch (error) {
            console.error('Error processing file:', error);
            alert(`Error: ${error.message}`);
        }
    }

    // ä»è·¯å¾„è·å–æ–‡ä»¶å¹¶å¤„ç†
    async function processFileFromPath(filePath, fileName) {
        try {
            const response = await fetch(filePath);
            if (!response.ok) {
                throw new Error(`Failed to fetch file: ${response.status}`);
            }

            // è·å–ArrayBuffer
            const arrayBuffer = await response.arrayBuffer();

            // åˆ›å»ºå®Œæ•´çš„æ¨¡æ‹Ÿæ–‡ä»¶å¯¹è±¡
            const mockFile = new File([arrayBuffer], fileName, {
                type: 'text/markdown',
                lastModified: Date.now()
            });

            await processFile(mockFile);
        } catch (error) {
            console.error('Error fetching file:', error);
            alert(`Error: ${error.message}`);
        }
    }

    // ä¿å­˜æ›´æ”¹
    document.querySelector('.saveButton').addEventListener('click', async () => {

        try {

            await saveJsonData(data);
            console.log('Changes saved successfully.');
        } catch (e) {
            console.log('Invalid JSON format.');
        }
    });

    // æ·»åŠ å¤‡æ³¨
    // document.getElementById('addNoteButton').addEventListener('click', () => {
    //     const textarea = document.getElementById('jsonData');
    //     try {
    //         const json = JSON.parse(textarea.value);
    //         json.push({ type: 'note', content: 'User added note at ' + new Date().toLocaleString() });
    //         textarea.value = JSON.stringify(json, null, 2);
    //         showMessage('Note added.');
    //     } catch (e) {
    //         showError('Failed to add note.');
    //     }
    // });

    // é‡ç½®æ•°æ®
    document.querySelector('.resetButton').addEventListener('click', async () => {
        // console.log(data)
        Object.keys(data).forEach(chapter => {
            let value = data[chapter]
            Object.keys(value).forEach(item => {
                if (data[chapter][item].length > 0) {

                    data[chapter][item].forEach((q, idx) => {
                        if (q.userAnswer) {
                            q.userAnswer = ""
                            q.chooseRight = undefined

                        }

                    })

                }

            })
        });
        await saveJsonData(data)
        // console.log(data)
        // try {
        //     await deleteJsonData();
        //     document.getElementById('result').style.display = 'none';
        //     document.getElementById('fileInput').value = '';
        //     showMessage('Data reset. Please upload a new file.');
        // } catch (e) {
        //     showError('Failed to reset data: ' + e.message);
        // }
    });

    // è§£ææ–‡ä»¶
    async function parseFile(file) {

        const extension = file.name.split('.').pop().toLowerCase();
        const arrayBuffer = await file.arrayBuffer();

        if (extension === 'md') {
            const text = new TextDecoder().decode(arrayBuffer);

            return parseMarkdown(text);
        } else if (extension === 'docx' || extension === 'doc') {
            // const result = await mammoth.extractRawText({ arrayBuffer });
            window.alert("æš‚ä¸æ”¯æŒé™¤mdæ–‡ä»¶ä»¥å¤–çš„æ–‡ä»¶!ğŸ˜")
            // return parseDocx(result.value);
        } else {
            window.alert("æš‚ä¸æ”¯æŒé™¤mdæ–‡ä»¶ä»¥å¤–çš„æ–‡ä»¶!ğŸ˜")
        }
    }

    // è§£æ Markdown
    function parseMarkdown(text) {
        return main(text)

    }

    // è§£æ Docx
    function parseDocx(text) {
        console.log(text)
        return text
            .split('\n')
            .filter(line => line.trim())
            .map(line => ({
                type: 'paragraph',
                content: line.trim()
            }));
    }

    // æ˜¾ç¤ºç»“æœ
    // function showResult(json) {
    //     const resultDiv = document.getElementById('result');
    //     const textarea = document.getElementById('jsonData');
    //     console.log(JSON.parse(json))
    //     textarea.value = JSON.parse(json);
    //     resultDiv.style.display = 'block';
    //     console.log('File converted successfully.');
    // }

    // // æ˜¾ç¤ºé”™è¯¯
    // function showError(message) {
    //     const messageP = document.getElementById('resultMessage');
    //     messageP.textContent = message;
    //     messageP.className = 'error';
    // }

    // // æ˜¾ç¤ºæ¶ˆæ¯
    // function showMessage(message) {
    //     const messageP = document.getElementById('resultMessage');
    //     messageP.textContent = message;
    //     messageP.className = '';
    // }
</script>
<script src="./index.js"></script>
</body>

</html>